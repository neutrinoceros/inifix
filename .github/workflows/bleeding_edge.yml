name: CI (bleeding edge)

on:
  schedule:
    # run this every wednesday at 3 am UTC
  - cron: 0 3 * * 3
  pull_request:
    paths:
    - .github/workflows/bleeding_edge.yml
  workflow_dispatch:

permissions: {}

jobs:
  build:
    name: py${{ matrix.python-version }}
    runs-on: ubuntu-latest
    timeout-minutes: 20

    strategy:
      fail-fast: false
      matrix:
        python-version:
        - '3.15'
        - 3.15t

    steps:
    - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      with:
        persist-credentials: false
    - uses: astral-sh/setup-uv@85856786d1ce8acfbcc2f13a5f3fbd6b938f9f41 # v7.1.2
      with:
        python-version: ${{ matrix.python-version }}
        enable-cache: false
    - name: Set PYTHON_GIL
      if: ${{ endswith( matrix.python-version , 't' ) }}
      run: |
        echo "PYTHON_GIL=0" >> $GITHUB_ENV

    - run: uv lock --upgrade --prerelease=allow
    - run: uv sync --frozen --no-editable --group test
    - name: Run tests
      run: |
        uv run --no-sync \
          pytest --color=yes

    - run: uv sync --frozen --no-editable --group concurrency
    - name: Run concurrency tests
      run: |
        uv run --no-sync \
          pytest --color=yes --count 100 -k concurrency
