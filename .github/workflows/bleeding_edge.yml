name: CI (bleeding edge)

on:
  schedule:
    # run this every wednesday at 3 am UTC
  - cron: 0 3 * * 3
  pull_request:
    paths:
    - .github/workflows/bleeding_edge.yml
  workflow_dispatch:

jobs:
  build:
    name: py${{ matrix.python-version }}
    runs-on: ubuntu-latest
    timeout-minutes: 20

    strategy:
      fail-fast: false
      matrix:
        python-version:
        - '3.14'
        - 3.14t

    steps:
    - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
    - uses: astral-sh/setup-uv@d0cc045d04ccac9d8b7881df0226f9e82c39688e # v6.8.0
      with:
        python-version: ${{ matrix.python-version }}
        enable-cache: false
    - name: Set PYTHON_GIL
      if: ${{ endswith( matrix.python-version , 't' ) }}
      run: |
        echo "PYTHON_GIL=0" >> $GITHUB_ENV

    - run: uv lock --upgrade --prerelease=allow
    - run: uv sync --frozen --no-editable --group test
    - name: Run tests
      run: |
        uv run --no-sync \
          pytest --color=yes

    - run: uv sync --frozen --no-editable --group concurrency
    - name: Run concurrency tests
      run: |
        uv run --no-sync \
          pytest --color=yes --count 100 -k concurrency
